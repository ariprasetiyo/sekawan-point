CREATE OR REPLACE FUNCTION updated_at_automatically()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at := now();
    RETURN NEW;
END;
$$ language plpgsql;

create table ms_users
(
    user_id varchar(255) primary key,
    username varchar,
    password_hash varchar,
    email varchar,
    email_hash varchar,
    phone_number varchar,
    phone_number_hash varchar,
    role_id varchar,
    is_active  bool,
    created_at timestamp with time zone not null,
    updated_at timestamp with time zone not null,
    deleted_at  timestamp with time zone default null
)
create index concurrently ms_users_username_idx on ms_users using btree(username)

CREATE TRIGGER updated_at_ms_users
BEFORE UPDATE ON ms_users
FOR EACH ROW EXECUTE PROCEDURE updated_at_automatically();

----

create table ms_roles
(
    id varchar(255) primary key,
    name varchar,
    description varchar,
    authorizations jsonb not null,
    is_active  bool,
    created_at timestamp with time zone not null,
    updated_at timestamp with time zone not null,
    deleted_at  timestamp with time zone default null
);

CREATE TRIGGER updated_at_ms_roles
BEFORE UPDATE ON ms_roles
FOR EACH ROW EXECUTE PROCEDURE updated_at_automatically();

create table ms_roles_url_authorization
(
    id varchar(255) primary key,
    role_id varchar(255) not null,
    url text not null,
    created_at timestamp with time zone not null,
    updated_at timestamp with time zone not null,
    deleted_at  timestamp with time zone default null
)

CREATE TRIGGER updated_at_ms_roles_url_authorization
BEFORE UPDATE ON ms_roles_url_authorization
FOR EACH ROW EXECUTE PROCEDURE updated_at_automatically();

create table ms_roles_menu
(
	id bigserial primary key,
    role_id varchar(255),
    menu_id int,
    created_at timestamp with time zone not null,
    updated_at timestamp with time zone default null
);

create index ms_roles_menu_role_id_idx on ms_roles_menu using btree(role_id)
create index ms_roles_menu_menu_id_idx on ms_roles_menu using btree(menu_id)

CREATE TRIGGER updated_at_ms_roles_menu
BEFORE UPDATE ON ms_roles_menu
FOR EACH ROW EXECUTE PROCEDURE updated_at_automatically();

insert into ms_roles_menu (role_id, menu_id, created_at) values
   ('super_admin', 1, now()),
   ('super_admin', 2, now() ),
   ('super_admin', 3, now() ),
   ('super_admin', 4, now() ),
   ('super_admin', 5, now() ),
   ('super_admin', 6, now() ),
   ('super_admin', 8, now() ),
   ('super_admin', 9, now() ),
   ('super_admin', 10, now() )

insert into ms_roles_menu (role_id, menu_id, created_at) values
   ('admin', 1, now()),
   ('admin', 2, now() ),
   ('admin', 3, now() ),
   ('admin', 4, now() ),
   ('admin', 6, now() )

 GRANT ALL PRIVILEGES ON TABLE ms_roles_menu TO sekawan;
 GRANT ALL PRIVILEGES ON TABLE ms_roles_menu TO postgres;
-------------------------------------

create table ms_menu
(
    id int primary key,
    seq int not null,
    name varchar,
    parent int,
    description varchar,
    icon varchar,
    url text,
    is_active  bool,
    created_at timestamp with time zone not null,
    updated_at timestamp with time zone not null,
    deleted_at  timestamp with time zone default null
);

CREATE TRIGGER updated_at_ms_menu
BEFORE UPDATE ON ms_menu
FOR EACH ROW EXECUTE PROCEDURE updated_at_automatically();

INSERT INTO ms_menu ( id, seq, name, parent, icon, url, is_active, created_at, updated_at)
values
( 1, 1, 'Dashboard', null, 'fas fa-fw fa-tachometer-alt', '#/nav-main', true, now(), now() ),
( 2, 2, 'Utilities',null, 'fas fa-fw fa-wrench','#', true, now(), now() ),
( 3, 3, 'Transaction', null ,'fas fa-fw fa-folder','#',true, now(), now() ),
( 4, 4, 'Registration user', 2, null, '#/nav-registration', true, now(), now() ),
( 5, 5, 'roles', 2, null,'#' ,true, now(), now() ),
( 6, 6, 'menus', 2, null,'#', true, now(), now() ),
( 8, 7, 'payment', 3,null, '#', true, now(), now() ),
( 9, 8, 'Payment in',  8, null, '#', true, now(), now() ),
( 10, 9, 'Payment out', 8,null,  '#', true, now(), now() )

INSERT into ms_roles (id, name, description, authorizations, is_active, created_at, updated_at) values ('super_admin', 'super admin', 'can access all', '{}', true, now(), now() )

INSERT into ms_roles_url_authorization (id, role_id, url,  created_at, updated_at)
values
(gen_random_uuid(), 'super_admin','/api/v1/registration', now(), now() ),
(gen_random_uuid(), 'super_admin','/backoffice', now(), now() ),
(gen_random_uuid(), 'super_admin','/internal', now(), now() ),
(gen_random_uuid(), 'super_admin','/api/*', now(), now() ),
(gen_random_uuid(), 'super_admin','/v1/admin/', now(), now() ),
(gen_random_uuid(), 'super_admin','/vendor', now(), now() ),
(gen_random_uuid(), 'super_admin','/css', now(), now() )

INSERT INTO ms_menu ( id, name, is_active, created_at, updated_at)
values
( gen_random_uuid(), 'dashboard', true, now(), now() ),
( gen_random_uuid(), 'registration user', true, now(), now() ),
( gen_random_uuid(), 'registration role', true, now(), now() )